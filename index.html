<!DOCTYPE html>
<html>
<head>
	<title>Rebble Configuration</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="https://code.jquery.com/mobile/1.4.1/jquery.mobile-1.4.1.min.css" />
	<script src="https://code.jquery.com/jquery-1.9.1.min.js"></script>
	<script src="https://code.jquery.com/mobile/1.4.1/jquery.mobile-1.4.1.min.js"></script>
	<script>
		function setDefaultOptions()
		{
			$('#username').val(getURLParameter("username", ""));
			$('#password').val(getURLParameter("password", ""));
			$('#subreddits_enabled').prop('checked', parseBool(getURLParameter("subreddits_enabled", "false"))).checkboxradio('refresh');
			$('#subreddits').val(getURLParameter("subreddits", ""));

			//onSubredditsEnabledChange();
		}

		function parseBool(val)
		{
			return val == "true" || val == 1;
		}

		function saveOptions()
		{
			var options = {
				'username': $("#username").val(),
				'password': $("#password").val(),
				'subreddits_enabled': $("#subreddits_enabled").is(":checked"),
				'subreddits': $("#subreddits").val()
			}
			return options;
		}

		function getURLParameter(name, def)
		{
			var ret = decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search)||[,""])[1].replace(/\+/g, '%20'))||null;
			if(ret === null)
			{
				return def;
			}
			return ret;
		}

		/*
		function onSubredditsEnabledChange()
		{
			if($("#subreddits_enabled").is(':checked'))
			{
				$('#subreddits').attr("disabled", false);
			}
			else
			{
				$('#subreddits').attr("disabled", "disabled");
			}
		}
		*/

		// https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/encodeURIComponent
		function fixedEncodeURIComponent(str)
		{
			return encodeURIComponent(str).replace(/[!'()]/g, escape).replace(/\*/g, "%2A");
		}

		$().ready(function()
		{
			$("#b-cancel").click(function() {
				document.location = "pebblejs://close";
			});

			$("#b-save").click(function() {
				var location = "pebblejs://close#" + fixedEncodeURIComponent(JSON.stringify(saveOptions()));
				document.location = location;
			});
			
			try
			{
				setDefaultOptions();
			}
			catch(ex)
			{

			}

			//$("#subreddits_enabled").bind("change", onSubredditsEnabledChange);
		});
	</script>
	<style>
		.ui-block-a
		{
			padding: 0 5px;
		}
		.ui-block-b
		{
			padding: 0 5px;
		}
	</style>
</head>
<body>
	<div data-role="page" id="main">
		<div data-role="content">
			<div class="ui-field-contain">
				<label for="username">Username:</label>
				<input type="text" name="username" id="username" autocapitalize="off" autocorrect="off" />
			</div>
			<div class="ui-field-contain">
				<label for="password">Password:</label>
				<input type="password" name="password" id="password" autocapitalize="off" autocorrect="off" />
			</div>
			<div class="ui-field-contain">
				<label for="subreddits_enabled">Use Custom Subreddits</label>
				<input type="checkbox" name="subreddits_enabled" id="subreddits_enabled" />
			</div>
			<div class="ui-field-contain">
				<label for="subreddits" class="select">Custom Subreddit(s):</label>
				<textarea name="subreddits" id="subreddits" autocapitalize="off" autocorrect="off" placeholder="aww,pics,jokes"></textarea>
			</div>
		</div>
		<div class="ui-grid-a">
			<div class="ui-block-a"><button type="submit" data-theme="d" id="b-cancel">Cancel</button></div>
			<div class="ui-block-b"><button type="submit" data-theme="a" id="b-save">Save</button></div>
		</div>
	</div>
</body>
</html>
